<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map and Location Submission</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAfIdLGhVXWF-JiBJuJle1Pp1YnHYutuC0&v=weekly" defer> </script>
    <style>
        body {
            padding: 20px;
        }

        .submission-container {
            max-width: 600px;
            margin: 0 auto;
        }

        h2 {
            margin-top: 20px;
        }

        form {
            margin-bottom: 30px;
        }

        label {
            margin-top: 10px;
            display: block;
        }

        input,
        select,
        textarea {
            margin-bottom: 10px;
        }

        button {
            margin-top: 20px;
        }
    </style>
    <script>
        function toggleTimerInput() {
            var timerActiveSelect = document.getElementById("timerActive");
            var timerSection = document.getElementById("timerSection");

            // Show or hide the timer input based on the selection
            timerSection.style.display = (timerActiveSelect.value === "yes") ? "block" : "none";
        }

        function validateForm() {
            var mapTitle = document.getElementById("mapTitle").value;
            var canMove = document.getElementById("canMove").value;
            var timerActive = document.getElementById("timerActive").value;
            var timerDuration = document.getElementById("timerDuration").value;
            var mapDescription = document.getElementById("mapDescription").value;
            var lat1 = document.getElementById("lat1").value;
            var long1 = document.getElementById("long1").value;
            var formRows = document.getElementsByClassName('form-row');
            var maps = formRows.length;
            console.log(maps);
            // Check if required fields are filled
            if (mapTitle && canMove && timerActive && mapDescription && lat1 && long1) {
                // If Timer is set to "Yes," ensure Timer Duration is filled
                if (timerActive === "yes" && !timerDuration) {
                    alert("Please fill the Timer Duration.");
                }
                checkCoordinates(maps);
            } else {
                alert("Please fill in all required fields.");
            }
        }

        // Array to store invalid locations
        var invalidLocations = [];

        function checkCoordinates(maps) {
            invalidLocations = [];
            var timerDuration = document.getElementById("timerDuration").value;
            if (timerDuration > 600) {
                alert("Timer duration cannot exceed 10 minutes.");
                return;
            }
            // Check each set of coordinates
            for (var i = 1; i <= maps; i++) {
                console.log("lat" + i);
                var lat = parseFloat(document.getElementById("lat" + i).value);
                var long = parseFloat(document.getElementById("long" + i).value);
                console.log(lat);
                console.log(long);
                var validStreet = validStreetView(lat, long, i);
         }
         // Check and alert for invalid locations
         var alertMessage = "Please enter valid coordinates for Locations: "
         setTimeout(() => { 
                if (invalidLocations.length > 0) {  
                invalidLocations.forEach(function (index) {
                    alertMessage = alertMessage + index + " ";
                });
                alert(alertMessage);
            } else {
                console.log("All coordinates are valid");
            }
            }, 300);
        }

        function validStreetView(latitude, longitude, i) {
            const streetViewService = new google.maps.StreetViewService();
            const streetViewLocation = { lat: latitude, lng: longitude };
            streetViewService.getPanorama(
                { location: streetViewLocation, radius: 1000, source: google.maps.StreetViewSource.OUTDOOR, preference: google.maps.StreetViewPreference.NEAREST},
                (data, status) => {
                    if (status === "OK") {
                        console.log("Location " + i + " is valid");
                    } else {
                        invalidLocations.push(i);
                    }
                }
            );
        }
        /////////////////////////////////////////////////////////////////
        // Code to add divs
        function addCoordinate() {
        // Create a new form row
        var newFormRow = document.createElement('div');
        newFormRow.classList.add('form-row');

        // Get the number of the new coordinate
        var coordinateNumber = document.getElementsByClassName('form-row').length + 1;

        // Create latitude input with label
        var latInput = createInput('text', 'form-control', 'Latitude (Location ' + coordinateNumber + '):', "lat" + coordinateNumber);
        latInput.name = "lat" + coordinateNumber;

        // Create longitude input with label
        var longInput = createInput('text', 'form-control', 'Longitude (Location ' + coordinateNumber + '):', "long" + coordinateNumber);
        longInput.name = "long" + coordinateNumber;

        // Append inputs to the new form row
        newFormRow.appendChild(createFormGroup('col-md-6', latInput));
        newFormRow.appendChild(createFormGroup('col-md-6', longInput));

        // Get the locationSubmissionForm
        var locationForm = document.getElementById('locationSubmissionForm');

        // Insert the new form row before the last child (Submit button)
        locationForm.insertBefore(newFormRow, locationForm.lastElementChild);

        // Add Delete button if there's more than one coordinate
        if (document.getElementsByClassName('form-row').length > 1) {
            addDeleteButton();
        }
        }

    // Code to add delete button
    function addDeleteButton() {
        // Check if delete button already exists
        if (!document.getElementById('deleteCoordinateBtn')) {
            var deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.classList.add('btn', 'btn-danger', 'ml-2'); // Added margin-left class
            deleteBtn.textContent = 'Delete Coordinate';
            deleteBtn.id = 'deleteCoordinateBtn';
            deleteBtn.onclick = deleteCoordinate;

            // Insert the delete button after the Add Coordinate button
            document.getElementById('addOrDeleteButtons').appendChild(deleteBtn);
        }
    }

    // Code to delete the last added coordinate
    function deleteCoordinate() {
        var formRows = document.getElementsByClassName('form-row');
        if (formRows.length > 1) {
            formRows[formRows.length - 1].remove();
        }

        // Remove Delete button if there's only one coordinate left
        if (formRows.length <= 1) {
            var deleteBtn = document.getElementById('deleteCoordinateBtn');
            if (deleteBtn) {
                deleteBtn.remove();
            }
        }
    }

    function createFormGroup(className, input) {
        var formGroup = document.createElement('div');
        formGroup.classList.add('form-group', className);
        formGroup.appendChild(input);
        return formGroup;
    }

    function createInput(type, className, label, id) {
        var input = document.createElement('input');
        input.type = type;
        input.classList.add(className);
        input.required = true;
        input.id = id

        var inputLabel = document.createElement('label');
        inputLabel.textContent = label;

        var inputContainer = document.createElement('div');
        inputContainer.appendChild(inputLabel);
        inputContainer.appendChild(input);

        return inputContainer;
    }

    /////////////////////////////////////////////////////////////////   

    </script>
</head>
<body>

    <div class="container submission-container">
        <h2>Map and Location Submission</h2>
        <form id="mapSubmissionForm">
            <div class="form-group">
                <label for="mapTitle">Map Title:</label>
                <input type="text" class="form-control" id="mapTitle" name="mapTitle" required>
            </div>

            <div class="form-group">
                <label for="canMove">Can Players Move?</label>
                <select class="form-control" id="canMove" name="canMove">
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                </select>
            </div>

            <div class="form-group">
                <label for="timerActive">Is Timer Active?</label>
                <select class="form-control" id="timerActive" name="timerActive" onchange="toggleTimerInput()">
                    <option value="no">No</option>
                    <option value="yes">Yes</option>
                </select>
            </div>

            <div id="timerSection" style="display: none;">
                <div class="form-group">
                    <label for="timerDuration">Timer Duration (in seconds, max 10 min):</label>
                    <input type="number" class="form-control" id="timerDuration" name="timerDuration" min="1">
                </div>
            </div>

            <div class="form-group">
                <label for="mapDescription">Map Description:</label>
                <textarea class="form-control" id="mapDescription" name="mapDescription" rows="4" required></textarea>
            </div>
        </form>

        <div id="addOrDeleteButtons">
        <button type="button" class="btn btn-secondary" onclick="addCoordinate()">Add Coordinate</button>
        </div>    
        <form id="locationSubmissionForm">
            <!-- Location 1 -->
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="lat1">Latitude (Location 1):</label>
                    <input type="text" class="form-control" id="lat1" name="lat1" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="long1">Longitude (Location 1):</label>
                    <input type="text" class="form-control" id="long1" name="long1" required>
                </div>
            </div>

            <button type="button" class="btn btn-primary" onclick="validateForm()">Submit</button>
        </form>
    </div>

</body>
</html>